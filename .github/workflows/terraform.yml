name: Deploy via Shared Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

permissions:
  id-token: write
  contents: read

jobs:
  terraform-deploy:
    name: Call Reusable Workflow
    # References the shared workflow in the central repository
    uses: fiilipjaworski31/shared-workflows/.github/workflows/terraform-logic.yml@main
    with:
      aws_region: "us-east-1"
      tf_version: "1.13.0"
      working_directory: "."
      environment_name: "production"
      # Pass the user input action (plan/apply/destroy) or default to 'plan' on push
      action: ${{ github.event.inputs.action || 'plan' }}
    secrets:
      # Pass secrets from the caller repository to the reusable workflow
      AWS_ROLE_PLAN_ARN: ${{ secrets.AWS_ROLE_PLAN_ARN }}
      AWS_ROLE_APPLY_ARN: ${{ secrets.AWS_ROLE_APPLY_ARN }}